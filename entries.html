<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Mary-Jean II — Past Entries</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="./styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
  </head>
  <body>
    <header class="app-header">
      <div class="brand">
        <img src="./assets/mary-jean-ii.png" alt="Mary-Jean II Logo" onerror="this.closest('.brand').classList.add('no-image')">
        <div class="brand-text">
          <h1>Mary-Jean II</h1>
          <p>Engine Room Log</p>
        </div>
      </div>
      <div class="header-actions">
        <a href="./index.html" class="btn secondary">Home</a>
        <a href="./running.html" class="btn secondary">ER Running Log</a>
      </div>
    </header>

    <main class="container wide">
      <section class="card open">
        <div class="card-header">
          <h2>Past Entries</h2>
          <div class="header-actions">
            <button id="exportAllBtn" class="btn">Export All to Excel</button>
            <button id="clearAll" class="btn secondary">Clear All</button>
          </div>
        </div>
        <div class="card-body">
          <p id="cloudStatus" style="margin:0 0 10px; color: var(--muted);"></p>
          <div id="entriesList" class="grid cols-1"></div>
        </div>
      </section>

      <section class="card open">
        <div class="card-header">
          <h2>Graph Data</h2>
        </div>
        <div class="card-body">
          <div class="grid cols-1" style="gap:16px;">
            <div class="row-actions">
              <button id="toggleGen" class="btn secondary">Generators</button>
              <button id="toggleEng" class="btn secondary">Main Engines</button>
              <button id="toggleOther" class="btn secondary">Other</button>
            </div>

            <div id="chooserGenWrap" class="grid cols-1 hidden" style="gap:10px;">
              <div class="subheading">Generators</div>
              <div class="row-actions">
                <button id="toggleGen1" class="btn secondary">Generator 1</button>
                <button id="toggleGen2" class="btn secondary">Generator 2</button>
                <button id="toggleGen3" class="btn secondary">Generator 3</button>
              </div>
              <div id="chooserGen1Wrap" class="grid cols-1 hidden" style="gap:8px;">
                <div id="seriesChooserGen1" class="grid cols-4"></div>
              </div>
              <div id="chooserGen2Wrap" class="grid cols-1 hidden" style="gap:8px;">
                <div id="seriesChooserGen2" class="grid cols-4"></div>
              </div>
              <div id="chooserGen3Wrap" class="grid cols-1 hidden" style="gap:8px;">
                <div id="seriesChooserGen3" class="grid cols-4"></div>
              </div>
            </div>
            <div id="chooserEngWrap" class="grid cols-1 hidden" style="gap:10px;">
              <div class="subheading">Main Engines</div>
              <div class="row-actions">
                <button id="togglePort" class="btn secondary">Port Main Engine</button>
                <button id="toggleStbd" class="btn secondary">Starboard Main Engine</button>
              </div>
              <div id="chooserPortWrap" class="grid cols-1 hidden" style="gap:8px;">
                <div id="seriesChooserPort" class="grid cols-4"></div>
              </div>
              <div id="chooserStbdWrap" class="grid cols-1 hidden" style="gap:8px;">
                <div id="seriesChooserStbd" class="grid cols-4"></div>
              </div>
            </div>
            <div id="chooserOtherWrap" class="grid cols-1 hidden" style="gap:10px;">
              <div class="subheading">Other</div>
              <div id="seriesChooserOther" class="grid cols-4"></div>
            </div>
            <div class="row-actions">
              <button id="plotBtn" class="btn">Plot Selected</button>
              <button id="clearPlotBtn" class="btn secondary">Clear Plot</button>
            </div>
            <canvas id="chart" height="140"></canvas>
          </div>
        </div>
      </section>
    </main>

    <footer class="app-footer">
      <span>© <span id="year"></span> Mary-Jean II — Engine Room</span>
    </footer>

    <script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
    <script src="./sb-config.js?v=sb1"></script>
    <script src="./cloud.js?v=sb1"></script>
    <script src="./schema.js?v=sb1"></script>
    <script>
      document.getElementById('year').textContent = new Date().getFullYear();

      const entriesList = document.getElementById('entriesList');
      const clearAllBtn = document.getElementById('clearAll');
      const seriesChooserGen1 = document.getElementById('seriesChooserGen1');
      const seriesChooserGen2 = document.getElementById('seriesChooserGen2');
      const seriesChooserGen3 = document.getElementById('seriesChooserGen3');
      const seriesChooserPort = document.getElementById('seriesChooserPort');
      const seriesChooserStbd = document.getElementById('seriesChooserStbd');
      const seriesChooserOther = document.getElementById('seriesChooserOther');
      const chooserGenWrap = document.getElementById('chooserGenWrap');
      const chooserEngWrap = document.getElementById('chooserEngWrap');
      const chooserOtherWrap = document.getElementById('chooserOtherWrap');
      const toggleGenBtn = document.getElementById('toggleGen');
      const toggleEngBtn = document.getElementById('toggleEng');
      const toggleOtherBtn = document.getElementById('toggleOther');
      const toggleGen1Btn = document.getElementById('toggleGen1');
      const toggleGen2Btn = document.getElementById('toggleGen2');
      const toggleGen3Btn = document.getElementById('toggleGen3');
      const chooserGen1Wrap = document.getElementById('chooserGen1Wrap');
      const chooserGen2Wrap = document.getElementById('chooserGen2Wrap');
      const chooserGen3Wrap = document.getElementById('chooserGen3Wrap');
      const togglePortBtn = document.getElementById('togglePort');
      const toggleStbdBtn = document.getElementById('toggleStbd');
      const chooserPortWrap = document.getElementById('chooserPortWrap');
      const chooserStbdWrap = document.getElementById('chooserStbdWrap');
      const plotBtn = document.getElementById('plotBtn');
      const clearPlotBtn = document.getElementById('clearPlotBtn');
      const chartCtx = document.getElementById('chart').getContext('2d');
      let chart;

      function getDeep(obj, path) {
        const parts = String(path).replace(/\]/g,'').split(/\.|\[/).filter(Boolean);
        return parts.reduce((acc,p)=>acc?acc[p]:undefined, obj);
      }

      function flatten(obj, prefix = '') {
        const out = {};
        Object.entries(obj || {}).forEach(([k, v]) => {
          if (k === '__meta' || k === 'signature') return;
          const p = prefix ? prefix + '.' + k : k;
          if (v && typeof v === 'object' && !Array.isArray(v)) {
            Object.assign(out, flatten(v, p));
          } else {
            out[p] = v;
          }
        });
        return out;
      }

      function slug(s){ return String(s).replace(/[^a-z0-9]+/gi,'_').toLowerCase(); }

      function buildLabelMapFromSchema() {
        const map = new Map();
        const S = window.ENGINE_ROOM_SCHEMA || [];
        S.forEach(sec => {
          if (sec.type === 'fields') {
            if (sec.groups) {
              sec.groups.forEach(g => (g.fields||[]).forEach(f => map.set(f.key, `${g.title} — ${f.label}`)));
            } else {
              (sec.fields||[]).forEach(f => map.set(f.key, f.label));
            }
          } else if (sec.type === 'composite') {
            (sec.children||[]).forEach(ch => {
              if (ch.subtype === 'gen-matrix') {
                const rows = ch.rows || [];
                [1,2,3].forEach(id => {
                  rows.forEach(r => map.set(`gen${id}.${slug(r)}`, `Gen ${id} — ${r}`));
                });
              }
            });
          }
        });
        return map;
      }

      function collectNumericFields(entries) {
        const labelMap = buildLabelMapFromSchema();
        const keys = new Map();
        entries.forEach(e => {
          const flat = flatten(e);
          Object.entries(flat).forEach(([k, v]) => {
            if (k === '__meta' || typeof v === 'boolean') return;
            const num = parseFloat(String(v).replace(/,/g,''));
            if (!Number.isNaN(num) && Number.isFinite(num)) {
              if (!keys.has(k)) keys.set(k, labelMap.get(k) || k);
            }
          });
        });
        return Array.from(keys.entries()).sort((a,b)=>String(a[1]).localeCompare(String(b[1])));
      }

      function renderChooser(container, options) {
        container.innerHTML = '';
        options.forEach(([key, label]) => {
          const wrap = document.createElement('label');
          wrap.style.display = 'grid';
          wrap.style.gridTemplateColumns = 'auto 1fr';
          wrap.style.alignItems = 'center';
          wrap.style.gap = '8px';
        
          const cb = document.createElement('input');
          cb.type = 'checkbox';
          cb.value = key;
          const span = document.createElement('span');
          span.textContent = label;
          wrap.appendChild(cb);
          wrap.appendChild(span);
          container.appendChild(wrap);
        });
      }

      function color(i){
        const palette = ['#67a1ff','#3fe0e8','#ff6b6b','#43d17a','#f6c851','#c084fc','#60a5fa','#f472b6','#fb7185'];
        return palette[i % palette.length];
      }

      function plotSelected(entries) {
        const selected = [seriesChooserGen1, seriesChooserGen2, seriesChooserGen3, seriesChooserPort, seriesChooserStbd, seriesChooserOther]
          .flatMap(c => Array.from(c.querySelectorAll('input[type="checkbox"]:checked')).map(cb=>cb.value));
        const labels = entries.map(e => new Date(e.__meta?.ts || Date.now()).toLocaleString());
        const datasets = selected.map((key, idx) => ({
          label: key,
          data: entries.map(e => {
            const v = getDeep(e, key);
            const n = parseFloat(String(v).replace(/,/g,''));
            return Number.isFinite(n) ? n : null;
          }),
          borderColor: color(idx),
          backgroundColor: color(idx) + '55',
          spanGaps: true,
          tension: 0.2
        }));
        if (chart) chart.destroy();
        chart = new Chart(chartCtx, {
          type: 'line',
          data: { labels, datasets },
          options: {
            responsive: true,
            scales: { y: { beginAtZero: false } },
            plugins: { legend: { position: 'bottom' } }
          }
        });
      }

      async function renderEntries() {
        entriesList.innerHTML = '';
        // Prefer cloud, fallback to local
        let entries = null;
        let statusText = '';
        if (window.cloud && window.cloud.enabled) {
          entries = await window.cloud.fetchEntries();
          statusText = `Cloud: ${entries ? 'connected' : 'error'}; `;
        }
        if (!entries) {
          const raw = localStorage.getItem('erlog:entries');
          entries = raw ? JSON.parse(raw) : [];
          statusText += `Local entries: ${entries.length}`;
        } else {
          statusText += `Cloud entries: ${entries.length}`;
        }
        const statusEl = document.getElementById('cloudStatus');
        if (statusEl) statusEl.textContent = statusText;
        if (entries.length === 0) {
          const empty = document.createElement('p');
          empty.textContent = 'No entries yet.';
          empty.style.color = 'var(--muted)';
          entriesList.appendChild(empty);
          return;
        }

        const numericOptions = collectNumericFields(entries);
        const gen1Opts = numericOptions.filter(([k]) => /^gen1\./.test(k));
        const gen2Opts = numericOptions.filter(([k]) => /^gen2\./.test(k));
        const gen3Opts = numericOptions.filter(([k]) => /^gen3\./.test(k));
        const portOpts = numericOptions.filter(([k]) => /^port\./.test(k));
        const stbdOpts = numericOptions.filter(([k]) => /^stbd\./.test(k));
        const otherOpts = numericOptions.filter(([k]) => /^other\./.test(k));
        renderChooser(seriesChooserGen1, gen1Opts);
        renderChooser(seriesChooserGen2, gen2Opts);
        renderChooser(seriesChooserGen3, gen3Opts);
        renderChooser(seriesChooserPort, portOpts);
        renderChooser(seriesChooserStbd, stbdOpts);
        renderChooser(seriesChooserOther, otherOpts);

        [...entries].reverse().forEach((entry, idx) => {
          const card = document.createElement('div');
          card.className = 'card subtle';
          const header = document.createElement('div');
          header.className = 'card-header';
          const title = document.createElement('h2');
          const dt = (entry.__meta && entry.__meta.iso) || new Date().toISOString();
          const dateStr = new Date(dt).toLocaleString();
          title.textContent = `Entry ${entries.length - idx} — ${dateStr}`;
          header.appendChild(title);
          const actions = document.createElement('div');
          actions.className = 'header-actions';
          const loadBtn = document.createElement('button');
          loadBtn.className = 'btn';
          loadBtn.textContent = 'Load into Form';
          loadBtn.addEventListener('click', () => {
            // Save to localStorage and navigate to form. The form will auto-activate gens from data
            localStorage.setItem('erlog:lastSubmit', JSON.stringify(entry));
            window.location.href = './running.html?load=last&ts=' + Date.now();
          });
          const viewBtn = document.createElement('button');
          viewBtn.className = 'btn secondary';
          viewBtn.textContent = 'View JSON';
          viewBtn.addEventListener('click', () => {
            const pre = document.createElement('pre');
            pre.textContent = JSON.stringify(entry, null, 2);
            pre.style.whiteSpace = 'pre-wrap';
            const body = document.createElement('div');
            body.className = 'card-body';
            body.appendChild(pre);
            card.appendChild(body);
          });
          
          const exportBtn = document.createElement('button');
          exportBtn.className = 'btn';
          exportBtn.textContent = 'Export to Excel';
          exportBtn.addEventListener('click', () => {
            if (window.exportEntryWithData) {
              const filename = `er-log-entry-${entry.date || 'entry'}-${entry.time || 'time'}`;
              if (window.exportEntryWithData(entry, filename)) {
                alert('Entry exported to Excel with data filled in');
              } else {
                alert('Export failed');
              }
            } else {
              alert('Export function not available');
            }
          });
          
          actions.appendChild(loadBtn);
          actions.appendChild(viewBtn);
          actions.appendChild(exportBtn);
          header.appendChild(actions);
          card.appendChild(header);
          entriesList.appendChild(card);
        });

        plotBtn.addEventListener('click', () => plotSelected(entries));
        clearPlotBtn.addEventListener('click', () => { if (chart) chart.destroy(); });

        const toggle = (wrap) => wrap.classList.toggle('hidden');
        toggleGenBtn.addEventListener('click', () => toggle(chooserGenWrap));
        toggleEngBtn.addEventListener('click', () => toggle(chooserEngWrap));
        toggleOtherBtn.addEventListener('click', () => toggle(chooserOtherWrap));

        const showOnly = (wraps, target) => {
          wraps.forEach(w => w.classList.add('hidden'));
          target.classList.remove('hidden');
        };
        // Generators: only show last clicked
        toggleGen1Btn.addEventListener('click', () => showOnly([chooserGen1Wrap, chooserGen2Wrap, chooserGen3Wrap], chooserGen1Wrap));
        toggleGen2Btn.addEventListener('click', () => showOnly([chooserGen1Wrap, chooserGen2Wrap, chooserGen3Wrap], chooserGen2Wrap));
        toggleGen3Btn.addEventListener('click', () => showOnly([chooserGen1Wrap, chooserGen2Wrap, chooserGen3Wrap], chooserGen3Wrap));
        // Main Engines: only show last clicked
        togglePortBtn.addEventListener('click', () => showOnly([chooserPortWrap, chooserStbdWrap], chooserPortWrap));
        toggleStbdBtn.addEventListener('click', () => showOnly([chooserPortWrap, chooserStbdWrap], chooserStbdWrap));
      }

      // Excel Export functionality
      function exportHistoricalData() {
        try {
          const entries = JSON.parse(localStorage.getItem('erlog:entries') || '[]');
          if (entries.length === 0) {
            alert('No historical data to export');
            return;
          }
          
          // Create workbook and worksheet
          const wb = XLSX.utils.book_new();
          
          // Headers
          const headers = [
            'Entry Date', 'Entry Time', 'From Port', 'To Port', 'Route/Notes',
            'Generator 1 - kW', 'Generator 1 - kVAr', 'Generator 1 - Hz',
            'Generator 1 - Amps A1', 'Generator 1 - Amps A2', 'Generator 1 - Amps A3',
            'Generator 1 - Voltage V1.2', 'Generator 1 - Voltage V2.3', 'Generator 1 - Voltage V3.1',
            'Generator 1 - RPM', 'Generator 1 - Fuel Consumption', 'Generator 1 - Load %',
            'Generator 1 - Coolant Temp', 'Generator 1 - Oil Pressure', 'Generator 1 - Fuel Temp',
            'Generator 1 - Fuel Pressure', 'Generator 1 - Sea Water Pressure', 'Generator 1 - Oil Temperature',
            'Generator 1 - Boost Pressure', 'Generator 1 - Inlet Air Temp', 'Generator 1 - Engine Hours',
            'Generator 1 - Battery Voltage',
            'Generator 2 - kW', 'Generator 2 - kVAr', 'Generator 2 - Hz',
            'Generator 2 - Amps A1', 'Generator 2 - Amps A2', 'Generator 2 - Amps A3',
            'Generator 2 - Voltage V1.2', 'Generator 2 - Voltage V2.3', 'Generator 2 - Voltage V3.1',
            'Generator 2 - RPM', 'Generator 2 - Fuel Consumption', 'Generator 2 - Load %',
            'Generator 2 - Coolant Temp', 'Generator 2 - Oil Pressure', 'Generator 2 - Fuel Temp',
            'Generator 2 - Fuel Pressure', 'Generator 2 - Sea Water Pressure', 'Generator 2 - Oil Temperature',
            'Generator 2 - Boost Pressure', 'Generator 2 - Inlet Air Temp', 'Generator 2 - Engine Hours',
            'Generator 2 - Battery Voltage',
            'Generator 3 - kW', 'Generator 3 - kVAr', 'Generator 3 - Hz',
            'Generator 3 - Amps A1', 'Generator 3 - Amps A2', 'Generator 3 - Amps A3',
            'Generator 3 - Voltage V1.2', 'Generator 3 - Voltage V2.3', 'Generator 3 - Voltage V3.1',
            'Generator 3 - RPM', 'Generator 3 - Fuel Consumption', 'Generator 3 - Load %',
            'Generator 3 - Coolant Temp', 'Generator 3 - Oil Pressure', 'Generator 3 - Fuel Temp',
            'Generator 3 - Fuel Pressure', 'Generator 3 - Sea Water Pressure', 'Generator 3 - Oil Temperature',
            'Generator 3 - Boost Pressure', 'Generator 3 - Inlet Air Temp', 'Generator 3 - Engine Hours',
            'Generator 3 - Battery Voltage',
            'Port Engine - RPM', 'Port Engine - Fuel Pressure', 'Port Engine - Oil Temp',
            'Port Engine - S/W Pressure', 'Port Engine - Boost Pressure', 'Port Engine - Scavenge Air',
            'Port Engine - Left Exhaust', 'Port Engine - Right Exhaust', 'Port Engine - Ex O/B Surface',
            'Port Engine - Fuel Differential', 'Port Engine - Oil Differential', 'Port Engine - Coolant Temp',
            'Port Engine - Oil Pressure', 'Port Engine - Trans Gear Temp', 'Port Engine - Trans Oil Pressure',
            'Port Engine - Fuel Consumption', 'Port Engine - Load %', 'Port Engine - Shaft Flow',
            'Port Engine - Thrust Bearing Temp', 'Port Engine - Ex Sea Water Press',
            'Starboard Engine - RPM', 'Starboard Engine - Fuel Pressure', 'Starboard Engine - Oil Temp',
            'Starboard Engine - S/W Pressure', 'Starboard Engine - Boost Pressure', 'Starboard Engine - Scavenge Air',
            'Starboard Engine - Left Exhaust', 'Starboard Engine - Right Exhaust', 'Starboard Engine - Ex O/B Surface',
            'Starboard Engine - Fuel Differential', 'Starboard Engine - Oil Differential', 'Starboard Engine - Coolant Temp',
            'Starboard Engine - Oil Pressure', 'Starboard Engine - Trans Gear Temp', 'Starboard Engine - Trans Oil Pressure',
            'Starboard Engine - Fuel Consumption', 'Starboard Engine - Load %', 'Starboard Engine - Shaft Flow',
            'Starboard Engine - Thrust Bearing Temp', 'Starboard Engine - Ex Sea Water Press',
            'Other - Sea Water Temp', 'Other - Day Tank Temp'
          ];
          
          const wsData = [headers];
          
          // Add each entry as a row
          entries.forEach(entry => {
            const row = [
              entry.date || '',
              entry.time || '',
              entry.from || '',
              entry.to || '',
              entry.route || '',
              entry['gen1.kw'] || '', entry['gen1.kvar'] || '', entry['gen1.hz'] || '',
              entry['gen1.amps_a1'] || '', entry['gen1.amps_a2'] || '', entry['gen1.amps_a3'] || '',
              entry['gen1.voltage_v1_2'] || '', entry['gen1.voltage_v2_3'] || '', entry['gen1.voltage_v3_1'] || '',
              entry['gen1.rpm'] || '', entry['gen1.fuel_consumption_l_min'] || '', entry['gen1.load_pct'] || '',
              entry['gen1.coolant_temp_°c'] || '', entry['gen1.oil_pressure_kpa'] || '', entry['gen1.fuel_temp_°c'] || '',
              entry['gen1.fuel_pressure_kpa'] || '', entry['gen1.sea_water_pressure_kpa'] || '', entry['gen1.oil_temperature'] || '',
              entry['gen1.boost_pressure_kpa'] || '', entry['gen1.inlet_air_temp_°c'] || '', entry['gen1.engine_hours'] || '',
              entry['gen1.battery_voltage'] || '',
              entry['gen2.kw'] || '', entry['gen2.kvar'] || '', entry['gen2.hz'] || '',
              entry['gen2.amps_a1'] || '', entry['gen2.amps_a2'] || '', entry['gen2.amps_a3'] || '',
              entry['gen2.voltage_v1_2'] || '', entry['gen2.voltage_v2_3'] || '', entry['gen2.voltage_v3_1'] || '',
              entry['gen2.rpm'] || '', entry['gen2.fuel_consumption_l_min'] || '', entry['gen2.load_pct'] || '',
              entry['gen2.coolant_temp_°c'] || '', entry['gen2.oil_pressure_kpa'] || '', entry['gen2.fuel_temp_°c'] || '',
              entry['gen2.fuel_pressure_kpa'] || '', entry['gen2.sea_water_pressure_kpa'] || '', entry['gen2.oil_temperature'] || '',
              entry['gen2.boost_pressure_kpa'] || '', entry['gen2.inlet_air_temp_°c'] || '', entry['gen2.engine_hours'] || '',
              entry['gen2.battery_voltage'] || '',
              entry['gen3.kw'] || '', entry['gen3.kvar'] || '', entry['gen3.hz'] || '',
              entry['gen3.amps_a1'] || '', entry['gen3.amps_a2'] || '', entry['gen3.amps_a3'] || '',
              entry['gen3.voltage_v1_2'] || '', entry['gen3.voltage_v2_3'] || '', entry['gen3.voltage_v3_1'] || '',
              entry['gen3.rpm'] || '', entry['gen3.fuel_consumption_l_min'] || '', entry['gen3.load_pct'] || '',
              entry['gen3.coolant_temp_°c'] || '', entry['gen3.oil_pressure_kpa'] || '', entry['gen3.fuel_temp_°c'] || '',
              entry['gen3.fuel_pressure_kpa'] || '', entry['gen3.sea_water_pressure_kpa'] || '', entry['gen3.oil_temperature'] || '',
              entry['gen3.boost_pressure_kpa'] || '', entry['gen3.inlet_air_temp_°c'] || '', entry['gen3.engine_hours'] || '',
              entry['gen3.battery_voltage'] || '',
              entry['port.rpm'] || '', entry['port.fuelPressure'] || '', entry['port.oilTemp'] || '',
              entry['port.swPressure'] || '', entry['port.boostPressure'] || '', entry['port.scavengeAir'] || '',
              entry['port.leftExhaust'] || '', entry['port.rightExhaust'] || '', entry['port.exSurface'] || '',
              entry['port.fuelDiff'] || '', entry['port.olDiff'] || '', entry['port.coolantTemp'] || '',
              entry['port.oilPressure'] || '', entry['port.transGearTemp'] || '', entry['port.transOilPressure'] || '',
              entry['port.fuelConsumption'] || '', entry['port.loadPct'] || '', entry['port.shaftFlow'] || '',
              entry['port.thrustBearingTemp'] || '', entry['port.exSeaWaterPress'] || '',
              entry['stbd.rpm'] || '', entry['stbd.fuelPressure'] || '', entry['stbd.oilTemp'] || '',
              entry['stbd.swPressure'] || '', entry['stbd.boostPressure'] || '', entry['stbd.scavengeAir'] || '',
              entry['stbd.leftExhaust'] || '', entry['stbd.rightExhaust'] || '', entry['stbd.exSurface'] || '',
              entry['stbd.fuelDiff'] || '', entry['stbd.oilDiff'] || '', entry['stbd.coolantTemp'] || '',
              entry['stbd.oilPressure'] || '', entry['stbd.transGearTemp'] || '', entry['stbd.transOilPressure'] || '',
              entry['stbd.fuelConsumption'] || '', entry['stbd.loadPct'] || '', entry['stbd.shaftFlow'] || '',
              entry['stbd.thrustBearingTemp'] || '', entry['stbd.exSeaWaterPress'] || '',
              entry['other.seaWaterTemp'] || '', entry['other.dayTankTemp'] || ''
            ];
            wsData.push(row);
          });
          
          // Create worksheet
          const ws = XLSX.utils.aoa_to_sheet(wsData);
          
          // Add to workbook
          XLSX.utils.book_append_sheet(wb, ws, 'Historical Data');
          
          // Auto-size columns
          const colWidths = headers.map(h => Math.max(h.length, 15));
          ws['!cols'] = colWidths.map(w => ({ width: w }));
          
          // Save file
          XLSX.writeFile(wb, `er-log-historical-data-${new Date().toISOString().split('T')[0]}.xlsx`);
          
          alert(`Exported ${entries.length} entries to Excel`);
        } catch (e) {
          console.error('Export failed:', e);
          alert('Export failed');
        }
      }

      // Wire export button
      const exportAllBtn = document.getElementById('exportAllBtn');
      if (exportAllBtn) {
        exportAllBtn.addEventListener('click', exportHistoricalData);
      }

      clearAllBtn.addEventListener('click', () => {
        if (confirm('Clear all saved entries?')) {
          localStorage.removeItem('erlog:entries');
          renderEntries();
        }
      });

      renderEntries();
      if (window.cloud && window.cloud.enabled) {
        window.cloud.subscribeEntries(() => renderEntries());
      }
    </script>
  </body>
  </html>


